variables:
  GIT_SUBMODULE_STRATEGY: recursive

# Build and publish docker image using Kaniko.
# From https://gitlab.cern.ch/gitlabci-examples/build_docker_image/
build-docker-image:
  stage: build
  variables:
    IMAGE_NAME: ${CI_REGISTRY_NAME}/oais
  image:
    name: gitlab-registry.cern.ch/ci-tools/docker-image-builder
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $IMAGE_NAME:latest --destination $IMAGE_NAME:$CI_COMMIT_SHA
    - echo "Image pushed to ${IMAGE_NAME}:latest and ${IMAGE_NAME}:$CI_COMMIT_SHA"

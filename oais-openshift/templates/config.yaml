apiVersion: v1
kind: ConfigMap
metadata:
  name: oais-platform-config
data:
  __init__.py: |
    import os

    {{- if .Values.oais.checkHostname }}
    ALLOWED_HOSTS = [ {{ .Values.oais.hostname | quote }} ]
    {{- else }}
    ALLOWED_HOSTS = [ "*" ]
    {{- end }}

    SECURE_PROXY_SSL_HEADER = ("HTTP_X_FORWARDED_PROTO", "https")

    DEBUG = False

    LOGIN_REDIRECT_URL = "/#/login/callback"

    DATABASES = {
      "default": {
        "ENGINE": "django.db.backends.postgresql",
        "NAME": os.environ["POSTGRESQL_DATABASE"],
        "USER": os.environ["POSTGRESQL_USER"],
        "PASSWORD": os.environ["POSTGRESQL_PASSWORD"],
        "HOST": "postgres",
      }
    }

    __all__ = [
      "ALLOWED_HOSTS",
      "DATABASES",
      "DEBUG",
      "LOGIN_REDIRECT_URL",
      "SECURE_PROXY_SSL_HEADER"
    ]
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  oais.conf: |
    server {
      listen 8080;

      {{- if .Values.oais.checkHostname }}
      server_name {{ .Values.oais.hostname }};
      {{- else }}
      server_name _;
      {{- end }}

      root /shared-assets;

      location /ping {
        return 200 "ok";
      }

      location / {
        index index.html;
        try_files $uri $uri/ /index.html;
      }

      location /api/ {
          proxy_set_header Host $http_host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
          proxy_pass http://localhost:8000;
      }
    }